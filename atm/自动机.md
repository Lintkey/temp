## 自动机

定义：对信号序列进行判定的数学模型

1. AC自动机：给定多个模式串，判定某串是否能匹配模式串
2. SAM自动机：给定单模式串，判定某串是否能匹配模式串的后缀
3. 回文自动机：给定单模式串，判定某串是否是模式串的回文子串

`fil`：当前状态对应串后缀(不包括当前状态)的最大匹配

`fil[t]`的性质：对某个终止态`t`跳`fil`，其操作相当于遍历`t`所对应串的后缀

如转移时允许失配后跳`fil`，那么上述自动机能寻找最大子串匹配

**为防止歧义，后面提及的转移均不能跳`fil`**

## SAM后缀自动机

SAM有以下性质：

1. 如匹配串是模式串的子串，其一定能在自动机上转移(也就是说其包含了所有子串的信息)
2. 状态`t`的`fil[t]`指向更短的状态`t'`或根节点
3. `len[t]`是状态`t`的最长匹配后缀(记为`lstr`)，长度`l`满足`len[fil[t]]<l&&l<=len[t]`的`lstr`的后缀都会转移到`t`

也就是说：

1. SAM上不同转移路径对应模式串的不同子串
2. SAM有一个或多个终止态。不同长度的后缀可能转移到相同的终止态，不同的是其转移路径不同

### 线性构造SAM

假若在原基础上构造，记上一终态为`ls`，要添加的字符为`ch`

1. 新建最长终态`cu`，给`ls`添加字符`ch`转移到`cu`
2. 跳`ls`的`fil`，直到遇到有`ch`转移的状态`p`或根，否则给经过的状态添加字符`ch`转移到`cu`。如最后没跳到根，分类讨论`len[p]+1`与`len[to[p][ch]]`，记`q=to[p][ch]`
   + 若`len[p]+1==len[q]`，可以让`fil[cu]=q`，这样长度小于等于`len[q]`的串会转移到`q`或`q`的`fil`链上，大于`len[q]`则转移到`cu`上，满足构造的要求
   + 若`len[p]+1<len[q]`，则有其他不属于当前串后缀的串也能转移到`q`(因为经过`p`到`q`的转移无法构成`q`状态的最大后缀)
     + 新建`q`的复制态`cl`，令`fil[cu]=cl`(也就是说`cl`是次终态)
     + 跳`p`的`fil`，如其`ch`转移为到`q`，修正为到`cl`(使得)，否则停止
     + 令`fil[q]=cl`，因为`cl`状态包含了比原`fil[q]`更长的串

### `fil`树

同AC自动机一样，构建完SAM后，所有节点的`fil`形成了一个树，父节点对应串会出现在子节点对应串的后缀，通过这个可以得知每个串的出现位置(子节点出现位置)、次数(子树大小`sz`)

#### [洛谷P3804](https://www.luogu.com.cn/problem/P3804)

注意到每个节点的`lstr`比短后缀更优，因此在`fil`树上树形DP取`max{len[s]*sz[s]}`即可

## PAM回文自动机

PAM有以下性质：

1. `fil`指向状态`t`对应回文的最长回文后缀的状态
2. 设添加上一个字符后，`ls`指向整个串的最长回文后缀状态`t`。假设要添加字符，通过跳`p=fil`并比较`S[i]?=S[i-len[p]-1]`，若相等便得到了当前的最长回文后缀，通过这一操作可得到添加后新增的状态节点，对于新增节点的`fil`，跳父节点的`fil`，重复上述步骤直到跳到最大后缀回文或`0`
3. 节点的转移方式是两边扩展